<!DOCTYPE HTML
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title>Mapbox开发</title>
    <link href="css/MapShow.css" rel="stylesheet" type="text/css" />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css' rel='stylesheet' />
    <!-- 导航定位 -->
    <script
        src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js"></script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css"
        type="text/css">
    <!-- 地理编码器 -->
    <script
        src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css"
        type="text/css">
    <!-- 绘图 -->
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.css'
        type='text/css' />
    <!--语言 -->
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v0.10.0/mapbox-gl-language.js'></script>
    <!-- Turf -->
    <script src='https://unpkg.com/@turf/turf@6.3.0/turf.min.js'></script>
    <!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 -->
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>

    <!-- 三维模型 -->
    <script src="https://unpkg.com/three@0.126.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.126.0/examples/js/loaders/GLTFLoader.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>

</head>

<body>

    <!-- 颜色管理div的style -->
    <style>
        .map-overlay {
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            position: absolute;
            width: 200px;
            top: 0;
            left: 0;
            padding: 10px;
        }

        .map-overlay .map-overlay-inner {
            background-color: #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .map-overlay-inner fieldset {
            border: none;
            padding: 0;
            margin: 0 0 10px;
        }

        .map-overlay-inner fieldset:last-child {
            margin: 0;
        }

        .map-overlay-inner select {
            width: 100%;
        }

        .map-overlay-inner label {
            display: block;
            font-weight: bold;
            margin: 0 0 5px;
        }

        .map-overlay-inner button {
            display: inline-block;
            width: 36px;
            height: 20px;
            border: none;
            cursor: pointer;
        }

        .map-overlay-inner button:focus {
            outline: none;
        }

        .map-overlay-inner button:hover {
            box-shadow: inset 0 0 0 3px rgba(0, 0, 0, 0.1);
        }
    </style>



    <div>
        <ul>
            <li><a href="#home">首页</a></li>
            <li class="dropdown">
                <a href="javascript:void(0)" class="dropbtn">地图显示</a>
                <div class="dropdown-content">
                    <a href="#1" onclick="ShowStreetMap()">街道地图</a>
                    <a href="#2" onclick="ShowMyStyleMap()">个性化地图</a>
                    <a href="#4" onclick="Add3DTerrainMap()">三维地形图</a>
                    <a href="#5" onclick="ShowLightMap()">亮色调地图</a>
                    <a href="#6" onclick="ShowDarkMap()">暗色调地图</a>
                    <a href="#7" onclick="ShowSatelliteMap()">卫星地图</a>
                    <a href="#8" onclick="ShowCuteMap()">卡通地图</a>
                    <a href="#3" onclick="AddContourLines()" id="ContourLine">显示等高线</a>
                </div>
            </li>
            <li class="dropdown">
                <a href="javascript:void(0)" class="dropbtn">空间分析</a>
                <div class="dropdown-content">
                    <a href="#1" onclick="CalTin()">TIN网构建</a>
                    <a href="#2" onclick="showPointbuffer()">点缓冲区</a>
                </div>
            </li>
            <li class="dropdown">
                <a href="javascript:void(0)" class="dropbtn">定位计算</a>
                <div class="dropdown-content">
                    <a href="#1" onclick="MoveToWuHan()">定位到武汉</a>
                    <a href="#2" onclick="CalDistance()">测距</a>
                    <a href="#3" onclick="CalArea()">测面</a>
                    <a href="#4" onclick="DaoHangStyle()">导航</a>
                </div>
            </li>
            <li class="dropdown">
                <a href="javascript:void(0)" class="dropbtn">三维模块</a>
                <div class="dropdown-content">
                    <a href="#1" onclick="AddAtmosphericSky()">天空模型</a>
                    <a href="#2" onclick="AddBuildingModel()">建筑模型</a>
                    <a href="#3" onclick="AddBuildingMoving()">建筑动态</a>
                </div>
            </li>
            <li class="dropdown">
                <a href="javascript:void(0)" class="dropbtn">添加三维模型</a>
                <div class="dropdown-content">
                    <a href="#1" onclick="Add3DModel()">添加三维模型</a>
                    <a href="#2" onclick="AddDuck()">添加小黄鸭</a>
                    <a href="#2" onclick="AddMyStyleModel()">自定义模型</a>
                </div>
            </li>
            <li class="dropdown">
                <a href="javascript:void(0)" class="dropbtn">室内地图</a>
                <div class="dropdown-content">
                    <a href="#1" onclick="AddDemoMapHome()">地图Demo</a>
                    <a href="#2" onclick="AddWHGuangGuMapHome()">武汉光谷</a>
                </div>
            </li>
            <li class="dropdown">
                <a href="javascript:void(0)" class="dropbtn">Web图层服务</a>
                <div class="dropdown-content">
                    <a href="#1" onclick="AddWebLayerNewJersey()">NEW JERSEY</a>
                    <a href="#2" onclick="AddWebLayerGuangxi()">广西图层</a>
                    <a href="#3" onclick="OpacityController()">透明度控制</a>
                </div>
            </li>
            <li class="dropdown">
                <a href="javascript:void(0)" class="dropbtn">语言切换</a>
                <div class="dropdown-content">
                    <a href="#1" onclick="Chinese()">中文</a>
                    <a href="#2" onclick="English()">英文</a>
                </div>
            </li>
            <li class="dropdown">
                <a href="javascript:void(0)" class="dropbtn">Cesium模块</a>
                <div class="dropdown-content">
                    <a href="CesiumEarth.html" target="_blank">Cesium Earth</a>
                    <a href="Cesium3DBuildings.html" target="_blank"">Cesium Buildings</a>
                </div>
            </li>


            <li style=" position: absolute; top: 0px;right: 0px; width: 100px;"><a href="register.html"
                            target="main">修改密码</a>
            </li>
            <li style="position: absolute; top: 0px;right: 100px;width: 70px;"><a href="login.html">退出</a></li>
            <li style="position: absolute; top: 0px;right: 170px;"><a href="login.html">返回</a></li>
        </ul>
    </div>

    <!--点缓冲区图层控件-->
    <div id="PointBuffer" class="easyui-window" title="点缓冲区" style="width: 300px; padding: 5px; left: 660px; top: 5px;">
        <fieldset id="layer1">
            <button id="btn" class="btn" onclick="showbuffer()" style="position: relative;">显示</button>
            <br>
            <label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;坐标：</label>
            <input name="lnglat" id="lnglat" class="txt" value="lng lat" />
            <label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;度量单位：</label>
            <select id="units" name="units" size="1">
                <option value="kilometers" selected=true>千米</option>
                <option value="degrees">度</option>
            </select>
            <br>
            <label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;半径：</label>
            <input name="radius" id="radius" class="txt" value="radius" />
        </fieldset>
    </div>


    <div id='map' style="position:absolute; z-index:-1"></div>

    <!--透明度-->
    <div class="map-overlay top" id="OpacityController">
        <div class="map-overlay-inner">
            <label>Layer opacity: <span id="slider-value">100%</span></label>
            <input id="slider" type="range" min="0" max="100" step="0" value="100">
        </div>
    </div>

    <!--z-index控制div叠置顺序，小的在底层-->
    <pre id="info"></pre>
    <div id="distance" class="distance-container"></div>

    <!--天空模型-->
    <div id="inputs" style="position:absolute; top:50px; left:50px; z-index:100;">
        <input type="button" id="sunriseEnd" value="sunrise">
        <input type="button" id="goldenHourEnd" value="morning">
        <input type="button" id="solarNoon" value="afternoon">
        <input type="button" id="goldenHour" value="evening">
        <input type="button" id="sunsetStart" value="sunset">
        <input type="button" id="getlocal" value="local time">
        <input type="button" id="next30mins" value="+30 mins">
        <input type="button" id="prev30mins" value="-30 mins">
        <input type="button" id="next30days" value="+30 days">
        <input type="button" id="prev30days" value="-30 days">
    </div>

    <!-- 颜色管理 -->
    <div class="map-overlay top" style="top:150px; right:40px;">
        <div class="map-overlay-inner">
            <fieldset>
                <label>Select layer</label>
                <select id="layer" name="layer">
                    <option value="water">Water</option>
                    <option value="building">Buildings</option>
                </select>
            </fieldset>
            <fieldset>
                <label>Choose a color</label>
                <div id="swatches"></div>
            </fieldset>
        </div>
    </div>

    <div class="calculation-box" style="display: none;" id="DrawPoly">
        <p>Draw a polygon using the draw tools.</p>
        <div id="calculated-area"></div>
    </div>





    <script>
        //初始化图层界面
        /*******************************************************************************************************************/
        var MapAccessToken = 'pk.eyJ1Ijoic2FtbGxub3J0aCIsImEiOiJja21ocmo5dzgwNGxhMnFsbmIxcHVzdGIwIn0.lNEko2yCuZYBbu703ybciA';
        var MapStyle = 'mapbox://styles/samllnorth/ckmhs8gkh0mhz17ofcwxlbdlj';
        mapboxgl.accessToken = MapAccessToken;
        var IsDaoHang = false;   //控制导航控件显示
        var map = new mapboxgl.Map({
            container: 'map',
            style: MapStyle,
            center: [108, 33],
            zoom: 4,
            touchZoomRotatez: true,
            antialias: true      //使用MSAA抗锯齿创建gl上下文，这样自定义图层就抗锯齿了
        });


        map.addControl(new mapboxgl.FullscreenControl());

        //颜色管理
        var swatches = document.getElementById('swatches');
        var layer = document.getElementById('layer');
        var colors = [
            '#ffffcc',
            '#a1dab4',
            '#41b6c4',
            '#2c7fb8',
            '#253494',
            '#fed976',
            '#feb24c',
            '#fd8d3c',
            '#f03b20',
            '#bd0026'
        ];

        colors.forEach(function (color) {
            var swatch = document.createElement('button');
            swatch.style.backgroundColor = color;
            swatch.addEventListener('click', function () {
                map.setPaintProperty(layer.value, 'fill-color', color);
            });
            swatches.appendChild(swatch);
        });



        var coordinatesGeocoder = function (query) {
            //坐标匹配
            var matches = query.match(
                /^[ ]*(?:Lat: )?(-?\d+\.?\d*)[, ]+(?:Lng: )?(-?\d+\.?\d*)[ ]*$/i
            );
            if (!matches) {
                return null;
            }
            //返回有效坐标
            function coordinateFeature(lng, lat) {
                return {
                    center: [lng, lat],
                    geometry: {
                        type: 'Point',
                        coordinates: [lng, lat]
                    },
                    place_name: 'Lat: ' + lat + ' Lng: ' + lng,
                    place_type: ['coordinate'],
                    properties: {},
                    type: 'Feature'
                };
            }
            var coord1 = Number(matches[1]);
            var coord2 = Number(matches[2]);
            var geocodes = [];
            if (coord1 < -90 || coord1 > 90) {
                // lng, lat
                geocodes.push(coordinateFeature(coord1, coord2));
            }
            if (coord2 < -90 || coord2 > 90) {
                //lat, lng
                geocodes.push(coordinateFeature(coord2, coord1));
            }
            if (geocodes.length === 0) {
                // else could be either lng, lat or lat, lng
                geocodes.push(coordinateFeature(coord1, coord2));
                geocodes.push(coordinateFeature(coord2, coord1));
            }
            return geocodes;
        };

        //地理编码器搜索控件
        map.addControl(
            new MapboxGeocoder({
                accessToken: mapboxgl.accessToken,
                localGeocoder: coordinatesGeocoder,
                zoom: 4,
                placeholder: '        Try: -40, 170',
                mapboxgl: mapboxgl
            })
        );
        // 放大、缩小、指北针控件
        map.addControl(new mapboxgl.NavigationControl(), 'top-left')

        //地图显示菜单栏
        /*******************************************************************************************************************/
        //显示街道地图
        function ShowStreetMap() {

            MapAccessToken = "pk.eyJ1Ijoic2FtbGxub3J0aCIsImEiOiJja21ocmo5dzgwNGxhMnFsbmIxcHVzdGIwIn0.lNEko2yCuZYBbu703ybciA";
            MapStyle = "mapbox://styles/mapbox/streets-v11";
            map.setStyle(MapStyle);
        }

        //显示个性化地图
        function ShowMyStyleMap() {
            var MapAccessToken = 'pk.eyJ1Ijoic2FtbGxub3J0aCIsImEiOiJja21ocmo5dzgwNGxhMnFsbmIxcHVzdGIwIn0.lNEko2yCuZYBbu703ybciA';
            var MapStyle = 'mapbox://styles/samllnorth/ckmhs8gkh0mhz17ofcwxlbdlj';
            map.setStyle(MapStyle);
        }

        //显示等高线
        function AddContourLines() {
            map.addSource('mapbox-terrain', {
                type: 'vector',
                // Use any Mapbox-hosted tileset using its tileset id.
                // Learn more about where to find a tileset id:
                url: 'mapbox://mapbox.mapbox-terrain-v2'
            });
            map.addLayer({
                'id': 'terrain-data',
                'type': 'line',
                'source': 'mapbox-terrain',
                'source-layer': 'contour',
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                'paint': {
                    'line-color': '#ff69b4',
                    'line-width': 1
                }
            });
        }

        //显示亮色调地图
        function ShowLightMap() {
            MapAccessToken = "pk.eyJ1Ijoic2FtbGxub3J0aCIsImEiOiJja21ocmo5dzgwNGxhMnFsbmIxcHVzdGIwIn0.lNEko2yCuZYBbu703ybciA";
            MapStyle = "mapbox://styles/mapbox/light-v9";
            map.setStyle(MapStyle);
        }

        //显示暗色调地图
        function ShowDarkMap() {
            MapAccessToken = "pk.eyJ1Ijoic2FtbGxub3J0aCIsImEiOiJja21ocmo5dzgwNGxhMnFsbmIxcHVzdGIwIn0.lNEko2yCuZYBbu703ybciA";
            MapStyle = "mapbox://styles/mapbox/dark-v9";
            map.setStyle(MapStyle);
        }

        //显示卫星地图
        function ShowSatelliteMap() {
            MapAccessToken = "pk.eyJ1Ijoic2FtbGxub3J0aCIsImEiOiJja21ocmo5dzgwNGxhMnFsbmIxcHVzdGIwIn0.lNEko2yCuZYBbu703ybciA";
            MapStyle = "mapbox://styles/mapbox/satellite-v9";
            map.setStyle(MapStyle);
        }



        //添加三维地形图
        function Add3DTerrainMap() {
            var MapAccessToken = 'pk.eyJ1Ijoic2FtbGxub3J0aCIsImEiOiJja21ocmo5dzgwNGxhMnFsbmIxcHVzdGIwIn0.lNEko2yCuZYBbu703ybciA';
            var MapStyle = 'mapbox://styles/mapbox-map-design/ckhqrf2tz0dt119ny6azh975y';
            map.setStyle(MapStyle);

            map.on('load', function () {
                map.addSource('mapbox-dem', {
                    'type': 'raster-dem',
                    'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
                    'tileSize': 512,
                    'maxzoom': 14
                });
                // add the DEM source as a terrain layer with exaggerated height
                map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });

                // add a sky layer that will show when the map is highly pitched
                map.addLayer({
                    'id': 'sky',
                    'type': 'sky',
                    'paint': {
                        'sky-type': 'atmosphere',
                        'sky-atmosphere-sun': [0.0, 0.0],
                        'sky-atmosphere-sun-intensity': 15
                    }
                });
            });
            map.setCenter([-114.34411, 32.6141]);
            map.setZoom(14);
            map.setPitch(85);

        }


        //显示卡通地图
        function ShowCuteMap() {
            MapAccessToken = "pk.eyJ1Ijoic2FtbGxub3J0aCIsImEiOiJja21ocmo5dzgwNGxhMnFsbmIxcHVzdGIwIn0.lNEko2yCuZYBbu703ybciA";
            MapStyle = "mapbox://styles/examples/cke97f49z5rlg19l310b7uu7j";
            map.setStyle(MapStyle);
        }

        //空间分析
        /*******************************************************************************************************************/
        //点缓冲区
        document.getElementById("PointBuffer").style.display = "none";
        function showPointbuffer() {
            if (document.getElementById("PointBuffer").style.display == "none") {
                document.getElementById("PointBuffer").style.display = "block";
                //isOpen1 = true;
            } else if (document.getElementById("PointBuffer").style.display == "block") {
                document.getElementById("PointBuffer").style.display = "none";
                //isOpen1 = false;
            }
        }
        function showbuffer() {
            //获取中心点坐标
            var lnglat = document.getElementById("lnglat").value.split(' ');
            console.log(lnglat);
            //获取缓冲半径
            var radius = document.getElementById("radius").value;
            console.log(radius);
            //获取度量单位
            var units = document.getElementById("units").options[document.getElementById("units").selectedIndex].value;
            console.log(units);
            //创建点
            var point = turf.point([parseFloat(lnglat[0]), parseFloat(lnglat[1])]);
            console.log(point);
            //创建缓冲区面
            var buffered = turf.buffer(point, parseFloat(radius), { steps: 2, units: units });
            console.log(buffered);
            //获取缓冲区面坐标数组
            var coordinates = buffered.geometry.coordinates[0];
            console.log(coordinates);
            // 获取缓冲区四至
            // 左下角坐标，min_lng，min_lat
            var es = [180, 90]
            // 右上角坐标，max_lng，max_lat
            var wn = [0, 0]
            for (var i = 0; i < coordinates.length; i++) {
                console.log(coordinates[i]);
                if (coordinates[i][0] < es[0]) {
                    es[0] = coordinates[i][0];
                }
                if (coordinates[i][1] < es[1]) {
                    es[1] = coordinates[i][1];
                }
                if (coordinates[i][0] > wn[0]) {
                    wn[0] = coordinates[i][0];
                }
                if (coordinates[i][1] > wn[1]) {
                    wn[1] = coordinates[i][1]
                }
            }
            console.log([es, wn]);
            //计算左下角到右上角的距离
            var distance = turf.distance(turf.point(es), turf.point(wn), { units: units });
            console.log(distance);
            //添加资源和图层
            map.addSource('polygon', {
                'type': 'geojson',
                'data': buffered
            });
            map.addLayer({
                'id': 'polygon',
                'type': 'fill',
                'source': 'polygon',
                'layout': {},
                'paint': {
                    'fill-color': '#088',
                    'fill-opacity': 0.8
                }
            });
            map.addSource('point', {
                'type': 'geojson',
                'data': point
            });
            map.addLayer({
                'id': 'point',
                'type': 'circle',
                'source': 'point',
                'paint': {
                    'circle-radius': 6,
                    'circle-color': '#B42222'
                }
            });
            //飞行至四至范围内
            map.fitBounds([es, wn], {
                padding: 20
            });
        }

        //计算功能
        /*******************************************************************************************************************/
        //测距
        var IsCalDis = false;
        function CalDistance() {
            // 存储正在绘制的线要素
            var geojson = {
                'type': 'FeatureCollection',
                'features': []
            };

            // 存储已经绘制完成的线要素
            var oldgeojson = {
                'type': 'FeatureCollection',
                'features': []
            };

            var helpTooltip = new mapboxgl.Popup({
                closeButton: false,
                anchor: 'top-left',
                offset: 10
            });

            var measureTooltip = new mapboxgl.Popup({
                closeButton: false,
                anchor: 'bottom',
                offset: 10
            });

            map.on('load', function () {
                // 绘制中的图层
                map.addSource('geojson', {
                    'type': 'geojson',
                    'data': geojson
                });

                // Add styles to the map
                map.addLayer({
                    id: 'measure-points',
                    type: 'circle',
                    source: 'geojson',
                    paint: {
                        'circle-radius': 5,
                        'circle-color': '#000'
                    },
                    filter: ['in', '$type', 'Point']
                });
                map.addLayer({
                    id: 'measure-lines',
                    type: 'line',
                    source: 'geojson',
                    layout: {
                        'line-cap': 'round',
                        'line-join': 'round'
                    },
                    paint: {
                        'line-color': '#000',
                        'line-width': 2.5
                    },
                    filter: ['in', '$type', 'LineString']
                });

                // 绘制完成的图层
                map.addSource('old-geojson', {
                    'type': 'geojson',
                    'data': oldgeojson
                });

                // Add styles to the map
                map.addLayer({
                    id: 'old-measure-points',
                    type: 'circle',
                    source: 'old-geojson',
                    paint: {
                        'circle-radius': 5,
                        'circle-color': '#ffcc33'
                    },
                    filter: ['in', '$type', 'Point']
                });
                map.addLayer({
                    id: 'old-measure-lines',
                    type: 'line',
                    source: 'old-geojson',
                    layout: {
                        'line-cap': 'round',
                        'line-join': 'round'
                    },
                    paint: {
                        'line-color': '#ffcc33',
                        'line-width': 2.5
                    },
                    filter: ['in', '$type', 'LineString']
                });
            });

            map.on('click', function (e) {
                if (geojson.features.length > 1) geojson.features.pop();
                var point = getPointFeature(e.lngLat.lng, e.lngLat.lat);
                geojson.features.push(point);
                if (geojson.features.length == 1) {
                    map.on('mousemove', onMouseMove);
                }
                if (geojson.features.length > 1) {
                    var linestring = getLineFeature(geojson.features)
                    geojson.features.push(linestring);
                }
                map.getSource('geojson').setData(geojson);
            });

            map.on('dblclick', function (e) {
                map.doubleClickZoom.disable();
                map.off('mousemove', onMouseMove);

                var linestring = geojson.features[geojson.features.length - 1];
                var value = turf.length(linestring).toLocaleString() + 'km';
                var lastPointCoord = geojson.features[geojson.features.length - 2].geometry.coordinates;
                var resultTooltip = new mapboxgl.Popup({
                    closeButton: false,
                    // 一定要设为false，否则默认点击地图关闭Popup
                    closeOnClick: false,
                    anchor: 'bottom',
                    offset: 10
                })
                    .setLngLat(lastPointCoord)
                    .setHTML(`<div class = 'tooltip result'>${value}</div>`)
                    .addTo(map);

                oldgeojson.features.push(...geojson.features);
                map.getSource('old-geojson').setData(oldgeojson);

                // 清空当前绘制的要素
                geojson.features = [];
                map.getSource('geojson').setData(geojson);
            });

            map.on('mousemove', onMouseMove);

            function onMouseMove(e) {
                if (geojson.features.length == 0) {
                    helpTooltip.setLngLat(e.lngLat)
                        .setHTML(`<div class = 'tooltip'>Click to start drawing</div>`)
                        .addTo(map);
                }
                if (geojson.features.length > 1) {
                    geojson.features.pop();
                    geojson.features.pop();
                }
                if (geojson.features.length > 0) {
                    helpTooltip.setLngLat(e.lngLat)
                        .setHTML(`<div class = 'tooltip'>Click to continue drawing</div>`)
                        .addTo(map);
                    var point = getPointFeature(e.lngLat.lng, e.lngLat.lat);
                    geojson.features.push(point);
                    if (geojson.features.length > 1) {
                        var linestring = getLineFeature(geojson.features)
                        geojson.features.push(linestring);
                        var value = turf.length(linestring).toLocaleString() + 'km';
                        measureTooltip.setLngLat(e.lngLat)
                            .setHTML(`<div class = 'tooltip'>${value}</div>`)
                            .addTo(map);
                    }
                    map.getSource('geojson').setData(geojson);
                }
            }

            function getPointFeature(lng, lat) {
                var point = {
                    'type': 'Feature',
                    'geometry': {
                        'type': 'Point',
                        'coordinates': [lng, lat]
                    },
                    'properties': {
                        'id': String(new Date().getTime())
                    }
                };

                return point;
            }

            function getLineFeature(features) {
                var linestring = {
                    'type': 'Feature',
                    'geometry': {
                        'type': 'LineString',
                        'coordinates': []
                    }
                };
                linestring.geometry.coordinates = features.map(
                    function (point) {
                        return point.geometry.coordinates;
                    }
                );
                return linestring;
            }
        }


        //定位到武汉
        function MoveToWuHan() {
            const bounds = [113, 29, 114, 30];
            map.fitBounds(bounds);
        }

        //测面
        function CalArea() {
            document.getElementById("DrawPoly").style.display = "block";
            var draw = new MapboxDraw({
                displayControlsDefault: false,
                controls: {
                    polygon: true,
                    trash: true
                }
            });
            map.addControl(draw);

            map.on('draw.create', updateArea);
            map.on('draw.delete', updateArea);
            map.on('draw.update', updateArea);

            function updateArea(e) {

                var data = draw.getAll();
                var answer = document.getElementById('calculated-area');
                if (data.features.length > 0) {
                    document.getElementById("DrawPoly").style.display = "block";
                    var area = turf.area(data);
                    // restrict to area to 2 decimal points
                    var rounded_area = Math.round(area * 100) / 100;
                    answer.innerHTML =
                        '<p><strong>' +
                        rounded_area +
                        '</strong></p><p>square meters</p>';
                } else {
                    document.getElementById("DrawPoly").style.display = "none";
                    answer.innerHTML = '';
                    if (e.type !== 'draw.delete')
                        alert('Use the draw tools to draw a polygon!');
                }
            }
        }


        //导航状态
        function DaoHangStyle() {
            IsDaoHang = true;
            if (IsDaoHang == true) {
                //导航控件
                map.addControl(
                    new MapboxDirections({
                        accessToken: mapboxgl.accessToken
                    }),
                    'bottom-left'
                );
            }
            else if (IsDaoHang == false) {
                //map.controls.MapboxDirections
            }
        }
        //语言切换
        /*******************************************************************************************************************/
        function Chinese() {

            map.on('load', function () {
                map.setLayoutProperty('country-label', 'text-field', [
                    'format',
                    ['get', 'name_zh'],
                    { 'font-scale': 1.2 },
                    '\n',
                    {},
                    ['get', 'name_zh'],
                    {
                        'font-scale': 0.8,
                        'text-font': [
                            'literal',
                            ['DIN Offc Pro Italic', 'Arial Unicode MS Regular']
                        ]
                    }
                ]);
            });
        }


        //鼠标位置
        map.on('mousemove', function (e) {
            document.getElementById('info').innerHTML =
                // e.point is the x, y coordinates of the mousemove event relative
                // to the top-left corner of the map
                JSON.stringify(e.point) +
                '<br />' +
                // e.lngLat is the longitude, latitude geographical position of the event
                JSON.stringify(e.lngLat.wrap());
        });







        //图层管理
        /*******************************************************************************************************************/




        //三维模块
        /*******************************************************************************************************************/
        //参数以确保模型在地图上被正确地引用
        var modelOrigin = [148.9819, -35.39847];
        var modelAltitude = 0;
        var modelRotate = [Math.PI / 2, 0, 0];
        var modelAsMercatorCoordinate = mapboxgl.MercatorCoordinate.fromLngLat(
            modelOrigin,
            modelAltitude
        );
        // transformation parameters to position, rotate and scale the 3D model onto the map
        var modelTransform = {
            translateX: modelAsMercatorCoordinate.x,
            translateY: modelAsMercatorCoordinate.y,
            translateZ: modelAsMercatorCoordinate.z,
            rotateX: modelRotate[0],
            rotateY: modelRotate[1],
            rotateZ: modelRotate[2],
            /* Since our 3D model is in real world meters, a scale transform needs to be
             * applied since the CustomLayerInterface expects units in MercatorCoordinates.
             */
            scale: modelAsMercatorCoordinate.meterInMercatorCoordinateUnits()
        };
        var THREE = window.THREE;
        //根据CustomLayerInterface为3D模型配置自定义层
        var customLayer = {
            id: '3d-model',
            type: 'custom',
            renderingMode: '3d',
            onAdd: function (map, gl) {
                this.camera = new THREE.Camera();
                this.scene = new THREE.Scene();

                // create two three.js lights to illuminate the model
                var directionalLight = new THREE.DirectionalLight(0xffffff);
                directionalLight.position.set(0, -70, 100).normalize();
                this.scene.add(directionalLight);

                var directionalLight2 = new THREE.DirectionalLight(0xffffff);
                directionalLight2.position.set(0, 70, 100).normalize();
                this.scene.add(directionalLight2);

                // use the three.js GLTF loader to add the 3D model to the three.js scene
                var loader = new THREE.GLTFLoader();
                loader.load(
                    'https://docs.mapbox.com/mapbox-gl-js/assets/34M_17/34M_17.gltf',
                    function (gltf) {
                        this.scene.add(gltf.scene);
                    }.bind(this)
                );
                this.map = map;

                // use the Mapbox GL JS map canvas for three.js
                this.renderer = new THREE.WebGLRenderer({
                    canvas: map.getCanvas(),
                    context: gl,
                    antialias: true
                });

                this.renderer.autoClear = false;
            },
            render: function (gl, matrix) {
                var rotationX = new THREE.Matrix4().makeRotationAxis(
                    new THREE.Vector3(1, 0, 0),
                    modelTransform.rotateX
                );
                var rotationY = new THREE.Matrix4().makeRotationAxis(
                    new THREE.Vector3(0, 1, 0),
                    modelTransform.rotateY
                );
                var rotationZ = new THREE.Matrix4().makeRotationAxis(
                    new THREE.Vector3(0, 0, 1),
                    modelTransform.rotateZ
                );

                var m = new THREE.Matrix4().fromArray(matrix);
                var l = new THREE.Matrix4()
                    .makeTranslation(
                        modelTransform.translateX,
                        modelTransform.translateY,
                        modelTransform.translateZ
                    )
                    .scale(
                        new THREE.Vector3(
                            modelTransform.scale,
                            -modelTransform.scale,
                            modelTransform.scale
                        )
                    )
                    .multiply(rotationX)
                    .multiply(rotationY)
                    .multiply(rotationZ);

                this.camera.projectionMatrix = m.multiply(l);
                this.renderer.resetState();
                this.renderer.render(this.scene, this.camera);
                this.map.triggerRepaint();
            }
        };
        function Add3DModel() {
            map.addLayer(customLayer, 'waterway-label');
            map.setCenter([148.9819, -35.3981]);
            map.setZoom(18);
            map.setPitch(50);
        }
        //小黄鸭参数
        var modelOrigin2 = [114.615022, 30.460630];
        var modelAltitude2 = 0;
        var modelRotate2 = [Math.PI / 2, 0, 0];
        var modelAsMercatorCoordinate2 = mapboxgl.MercatorCoordinate.fromLngLat(
            modelOrigin2,
            modelAltitude2
        );
        // transformation parameters to position, rotate and scale the 3D model onto the map
        var modelTransform2 = {
            translateX: modelAsMercatorCoordinate2.x,
            translateY: modelAsMercatorCoordinate2.y,
            translateZ: modelAsMercatorCoordinate2.z,
            rotateX: modelRotate2[0],
            rotateY: modelRotate2[1],
            rotateZ: modelRotate2[2],
            /* Since our 3D model is in real world meters, a scale transform needs to be
             * applied since the CustomLayerInterface expects units in MercatorCoordinates.
             */
            scale: modelAsMercatorCoordinate.meterInMercatorCoordinateUnits()
        };
        var THREE = window.THREE;
        var DuckCustomLayer = {
            id: '3d-model-duck',
            type: 'custom',
            renderingMode: '3d',
            onAdd: function (map, gl) {
                this.camera = new THREE.Camera();
                this.scene = new THREE.Scene();

                // create two three.js lights to illuminate the model
                var directionalLight = new THREE.DirectionalLight(0xffffff);
                directionalLight.position.set(0, -70, 100).normalize();
                this.scene.add(directionalLight);

                var directionalLight2 = new THREE.DirectionalLight(0xffffff);
                directionalLight2.position.set(0, 70, 100).normalize();
                this.scene.add(directionalLight2);

                // use the three.js GLTF loader to add the 3D model to the three.js scene
                var loader = new THREE.GLTFLoader();
                loader.load(
                    'https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/models/gltf/Duck/glTF-Embedded/Duck.gltf',
                    function (gltf) {
                        this.scene.add(gltf.scene);
                    }.bind(this)
                );
                this.map = map;

                // use the Mapbox GL JS map canvas for three.js
                this.renderer = new THREE.WebGLRenderer({
                    canvas: map.getCanvas(),
                    context: gl,
                    antialias: true
                });

                this.renderer.autoClear = false;
            },
            render: function (gl, matrix) {
                var rotationX = new THREE.Matrix4().makeRotationAxis(
                    new THREE.Vector3(1, 0, 0),
                    modelTransform2.rotateX
                );
                var rotationY = new THREE.Matrix4().makeRotationAxis(
                    new THREE.Vector3(0, 1, 0),
                    modelTransform2.rotateY
                );
                var rotationZ = new THREE.Matrix4().makeRotationAxis(
                    new THREE.Vector3(0, 0, 1),
                    modelTransform2.rotateZ
                );

                var m = new THREE.Matrix4().fromArray(matrix);
                var l = new THREE.Matrix4()
                    .makeTranslation(
                        modelTransform2.translateX,
                        modelTransform2.translateY,
                        modelTransform2.translateZ
                    )
                    .scale(
                        new THREE.Vector3(
                            modelTransform2.scale,
                            -modelTransform2.scale,
                            modelTransform2.scale
                        )
                    )
                    .multiply(rotationX)
                    .multiply(rotationY)
                    .multiply(rotationZ);

                this.camera.projectionMatrix = m.multiply(l);
                this.renderer.resetState();
                this.renderer.render(this.scene, this.camera);
                this.map.triggerRepaint();
            }
        };

        function AddDuck() {
            map.addLayer(DuckCustomLayer, 'waterway-label');
            map.setCenter([114.615022, 30.460630]);
            map.setZoom(25);
            map.setPitch(50);
        }
        // configuration of the custom layer for a 3D model per the CustomLayerInterface
        var MycustomLayer = {
            id: '3d-model',
            type: 'custom',
            renderingMode: '3d',
            onAdd: function (map, gl) {
                this.camera = new THREE.Camera();
                this.scene = new THREE.Scene();

                // create two three.js lights to illuminate the model
                var directionalLight = new THREE.DirectionalLight(0xffffff);
                directionalLight.position.set(0, -70, 100).normalize();
                this.scene.add(directionalLight);

                var directionalLight2 = new THREE.DirectionalLight(0xffffff);
                directionalLight2.position.set(0, 70, 100).normalize();
                this.scene.add(directionalLight2);

                // use the three.js GLTF loader to add the 3D model to the three.js scene
                var loader = new THREE.GLTFLoader();
                loader.load(
                    'data/CesiumMilkTruck.gltf',
                    function (gltf) {
                        this.scene.add(gltf.scene);
                    }.bind(this)
                );
                this.map = map;

                // use the Mapbox GL JS map canvas for three.js
                this.renderer = new THREE.WebGLRenderer({
                    canvas: map.getCanvas(),
                    context: gl,
                    antialias: true
                });

                this.renderer.autoClear = false;
            },
            render: function (gl, matrix) {
                var rotationX = new THREE.Matrix4().makeRotationAxis(
                    new THREE.Vector3(1, 0, 0),
                    modelTransform.rotateX
                );
                var rotationY = new THREE.Matrix4().makeRotationAxis(
                    new THREE.Vector3(0, 1, 0),
                    modelTransform.rotateY
                );
                var rotationZ = new THREE.Matrix4().makeRotationAxis(
                    new THREE.Vector3(0, 0, 1),
                    modelTransform.rotateZ
                );

                var m = new THREE.Matrix4().fromArray(matrix);
                var l = new THREE.Matrix4()
                    .makeTranslation(
                        modelTransform.translateX,
                        modelTransform.translateY,
                        modelTransform.translateZ
                    )
                    .scale(
                        new THREE.Vector3(
                            modelTransform.scale,
                            -modelTransform.scale,
                            modelTransform.scale
                        )
                    )
                    .multiply(rotationX)
                    .multiply(rotationY)
                    .multiply(rotationZ);

                this.camera.projectionMatrix = m.multiply(l);
                this.renderer.resetState();
                this.renderer.render(this.scene, this.camera);
                this.map.triggerRepaint();
            }
        };
        function AddMyStyleModel() {
            map.addLayer(MycustomLayer, 'Mywaterway-label');
            map.setCenter([148.9819, -35.3981]);
            map.setZoom(18);
        }

        //天空模型
        document.getElementById("inputs").style.display = "none";
        function AddAtmosphericSky() {
            if (document.getElementById("inputs").style.display == "none") {
                document.getElementById("inputs").style.display = "block";
            } else if (document.getElementById("inputs").style.display == "block") {
                document.getElementById("inputs").style.display = "none";
            }
            mapboxgl.accessToken = 'pk.eyJ1IjoiZGVuZ3lhb3ppIiwiYSI6ImNrbXZ3NHFxMTA5ODIybnA2eGNjY3ZuMXAifQ.nsbYYGBUMroFneBfgZ5yxQ';
            MapStyle = "mapbox://styles/mapbox-map-design/ckhqrf2tz0dt119ny6azh975y";
            map.setStyle(MapStyle);
            map.setCenter([127.60597, 35.67283]);
            map.setPitch(83);
            map.setZoom(15);

            //当样式加载时，添加一个天空图层
            map.on('load', function () {
                map.addSource('mapbox-dem', {
                    'type': 'raster-dem',
                    'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
                    'tileSize': 512,
                    'maxzoom': 14
                });
                map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });
                map.addLayer({
                    'id': 'sky',
                    'type': 'sky',
                    'paint': {
                        'sky-opacity': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            0,
                            0,
                            5,
                            0.3,
                            8,
                            1
                        ],
                        //为大气散射设置天空层
                        'sky-type': 'atmosphere',
                        //明确地设定太阳的位置，而不是让太阳附着在主光源上
                        'sky-atmosphere-sun': getSunPosition(),
                        //将太阳强度设置为光源(0-100，天空越亮值越高)
                        'sky-atmosphere-sun-intensity': 5
                    }
                });
            });

            function updateSunPosition(sunPos) {
                //根据选择的时间，使用SunCalc库计算太阳的位置，用太阳的位置更新“sky-atmosphere-sun”绘制属性
                //update the `sky-atmosphere-sun` paint property with the position of the sun based on the selected time
                //the position of the sun is calculated using the SunCalc library
                map.setPaintProperty('sky', 'sky-atmosphere-sun', sunPos);
            }

            //为按钮设置事件监听器，以更新一天中太阳的位置
            var sunTimeLabels = [
                'sunriseEnd',
                'goldenHourEnd',
                'solarNoon',
                'goldenHour',
                'sunsetStart'
            ];
            var sunTimes = SunCalc.getTimes(
                Date.now(),
                map.getCenter().lat,
                map.getCenter().lng
            );
            sunTimeLabels.forEach(function (btnId) {
                document.getElementById(btnId).addEventListener('click', function () {
                    var sunPos = getSunPosition(sunTimes[btnId]);
                    updateSunPosition(sunPos);
                });
            });

            var date = new Date();
            //当你改变时间时太阳的位置时，为要更新的按钮设置事件监听器
            document
                .getElementById('next30mins')
                .addEventListener('click', function () {
                    date.setTime(date.getTime() + 30 * 60 * 1000);
                    var sunPos = getSunPosition(date);
                    updateSunPosition(sunPos);
                });
            document
                .getElementById('prev30mins')
                .addEventListener('click', function () {
                    date.setTime(date.getTime() - 30 * 60 * 1000);
                    var sunPos = getSunPosition(date);
                    updateSunPosition(sunPos);
                });
            document
                .getElementById('next30days')
                .addEventListener('click', function () {
                    date.setMonth(date.getMonth() + 1);
                    var sunPos = getSunPosition(date);
                    updateSunPosition(sunPos);
                });
            document
                .getElementById('prev30days')
                .addEventListener('click', function () {
                    date.setMonth(date.getMonth() - 1);
                    var sunPos = getSunPosition(date);
                    updateSunPosition(sunPos);
                });
            document.getElementById('getlocal').addEventListener('click', function () {
                date = new Date();
                var sunPos = getSunPosition(date);
                updateSunPosition(sunPos);
            });

            function getSunPosition(date) {
                var center = map.getCenter();
                var sunPos = SunCalc.getPosition(
                    date || Date.now(),
                    center.lat,
                    center.lng
                );
                var sunAzimuth = 180 + (sunPos.azimuth * 180) / Math.PI;
                var sunAltitude = 90 - (sunPos.altitude * 180) / Math.PI;
                return [sunAzimuth, sunAltitude];
            }
        }

        function AddBuildingModel() {
            MapAccessToken = "pk.eyJ1Ijoic2FtbGxub3J0aCIsImEiOiJja21ocmo5dzgwNGxhMnFsbmIxcHVzdGIwIn0.lNEko2yCuZYBbu703ybciA";
            MapStyle = "mapbox://styles/mapbox/light-v9";
            map.setStyle(MapStyle);
            map.setCenter([-74.0066, 40.7135]);
            map.setZoom(15);
            map.setPitch(45);   //设置地图俯仰角
            map.setBearing(-17.6);
            map.on('load', function () {
                map.addLayer({
                    'id': '3d-buildings',
                    'source': 'composite',
                    'source-layer': 'building',
                    'filter': ['==', 'extrude', 'true'],  /* 过滤器 */
                    'type': 'fill-extrusion',
                    'minzoom': 15,
                    'paint': {
                        'fill-extrusion-color': '#aaa',
                        'fill-extrusion-height': {  /* 使用source中的height属性为fill-extrusion-height赋值 */
                            'type': 'identity',
                            'property': 'height'
                        },
                        'fill-extrusion-base': {
                            'type': 'identity',
                            'property': 'min_height'
                        },
                        'fill-extrusion-opacity': 0.8
                    }
                });
            });
        }

        function AddBuildingMoving() {
            mapboxgl.accessToken = 'pk.eyJ1IjoiZGVuZ3lhb3ppIiwiYSI6ImNrbXZ3NHFxMTA5ODIybnA2eGNjY3ZuMXAifQ.nsbYYGBUMroFneBfgZ5yxQ';
            /* global Promise */
            map = new mapboxgl.Map({
                style: 'mapbox://styles/examples/cj68bstx01a3r2rndlud0pwpv',
                center: {
                    lng: -74.00649562332922,
                    lat: 40.70811328605049
                },
                zoom: 15,
                pitch: 55,
                container: 'map',
                antialias: true
            });

            map.on('load', function () {
                var bins = 16;
                var maxHeight = 200;
                var binWidth = maxHeight / bins;

                // Divide the buildings into 16 bins based on their true height, using a layer filter.
                for (var i = 0; i < bins; i++) {
                    map.addLayer({
                        'id': '3d-buildings-' + i,
                        'source': 'composite',
                        'source-layer': 'building',
                        'filter': [
                            'all',
                            ['==', 'extrude', 'true'],
                            ['>', 'height', i * binWidth],
                            ['<=', 'height', (i + 1) * binWidth]
                        ],
                        'type': 'fill-extrusion',
                        'minzoom': 15,
                        'paint': {
                            'fill-extrusion-color': '#aaa',
                            'fill-extrusion-height-transition': {
                                duration: 0,
                                delay: 0
                            },
                            'fill-extrusion-opacity': 0.6
                        }
                    });
                }

                // Older browsers might not implement mediaDevices at all, so we set an empty object first
                if (navigator.mediaDevices === undefined) {
                    navigator.mediaDevices = {};
                }

                // Some browsers partially implement mediaDevices. We can't just assign an object
                // with getUserMedia as it would overwrite existing properties.
                // Here, we will just add the getUserMedia property if it's missing.
                if (navigator.mediaDevices.getUserMedia === undefined) {
                    navigator.mediaDevices.getUserMedia = function (constraints) {
                        // First get ahold of the legacy getUserMedia, if present
                        var getUserMedia =
                            navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

                        // Some browsers just don't implement it - return a rejected promise with an error
                        // to keep a consistent interface
                        if (!getUserMedia) {
                            return Promise.reject(
                                new Error(
                                    'getUserMedia is not implemented in this browser'
                                )
                            );
                        }

                        // Otherwise, wrap the call to the old navigator.getUserMedia with a Promise
                        return new Promise(function (resolve, reject) {
                            getUserMedia.call(navigator, constraints, resolve, reject);
                        });
                    };
                }

                navigator.mediaDevices
                    .getUserMedia({ audio: true })
                    .then(function (stream) {
                        // Set up a Web Audio AudioContext and AnalyzerNode, configured to return the
                        // same number of bins of audio frequency data.
                        var audioCtx = new (window.AudioContext ||
                            window.webkitAudioContext)();

                        var analyser = audioCtx.createAnalyser();
                        analyser.minDecibels = -90;
                        analyser.maxDecibels = -10;
                        analyser.smoothingTimeConstant = 0.85;

                        var source = audioCtx.createMediaStreamSource(stream);
                        source.connect(analyser);

                        analyser.fftSize = bins * 2;

                        var dataArray = new Uint8Array(bins);

                        function draw(now) {
                            analyser.getByteFrequencyData(dataArray);

                            // Use that data to drive updates to the fill-extrusion-height property.
                            var avg = 0;
                            for (var i = 0; i < bins; i++) {
                                avg += dataArray[i];
                                map.setPaintProperty(
                                    '3d-buildings-' + i,
                                    'fill-extrusion-height',
                                    10 + 4 * i + dataArray[i]
                                );
                            }
                            avg /= bins;

                            // Animate the map bearing and light color over time, and make the light more
                            // intense when the audio is louder.
                            map.setBearing(now / 500);
                            map.setLight({
                                color:
                                    'hsl(' +
                                    ((now / 100) % 360) +
                                    ',' +
                                    Math.min(50 + avg / 4, 100) +
                                    '%,50%)',
                                intensity: Math.min(1, (avg / 256) * 10)
                            });

                            requestAnimationFrame(draw);
                        }

                        requestAnimationFrame(draw);
                    })
                    .catch(function (err) {
                        console.log('The following gUM error occured: ' + err);
                    });
            });
        }




        //Web室内地图
        /*******************************************************************************************************************/
        function AddDemoMapHome() {
            map.addSource('floorplan', {
                // GeoJSON Data source used in vector tiles, documented at
                // https://gist.github.com/ryanbaumann/a7d970386ce59d11c16278b90dde094d
                'type': 'geojson',
                'data':
                    'https://docs.mapbox.com/mapbox-gl-js/assets/indoor-3d-map.geojson'
            });
            map.addLayer({
                'id': 'room-extrusion',
                'type': 'fill-extrusion',
                'source': 'floorplan',
                'paint': {
                    // See the Mapbox Style Specification for details on data expressions.
                    // https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions

                    // Get the fill-extrusion-color from the source 'color' property.
                    'fill-extrusion-color': ['get', 'color'],

                    // Get fill-extrusion-height from the source 'height' property.
                    'fill-extrusion-height': ['get', 'height'],

                    // Get fill-extrusion-base from the source 'base_height' property.
                    'fill-extrusion-base': ['get', 'base_height'],

                    // Make extrusions slightly opaque for see through indoor walls.
                    'fill-extrusion-opacity': 0.5
                }
            });
            map.setCenter([-87.61694, 41.86625]);
            map.setZoom(16);
        }


        //光谷
        function AddWHGuangGuMapHome() {
            mapboxgl.accessToken = 'pk.eyJ1IjoiZGVuZ3lhb3ppIiwiYSI6ImNrbXZ3NHFxMTA5ODIybnA2eGNjY3ZuMXAifQ.nsbYYGBUMroFneBfgZ5yxQ';
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/dengyaozi/cknkckbqn1zc817o50bv2u5fm',
                center: [108, 33],
                zoom: 4,
                touchZoomRotatez: true
            });
            map.setCenter([114.39917729164885, 30.506124660380785]);
            map.setZoom(16);
        }

        //Web图层服务
        /*******************************************************************************************************************/
        function AddWebLayerNewJersey() {
            map.addSource('wms-test-source', {
                'type': 'raster',
                // use the tiles option to specify a WMS tile source URL
                // https://docs.mapbox.com/mapbox-gl-js/style-spec/sources/
                'tiles': [
                    'https://img.nj.gov/imagerywms/Natural2015?bbox={bbox-epsg-3857}&format=image/png&service=WMS&version=1.1.1&request=GetMap&srs=EPSG:3857&transparent=true&width=256&height=256&layers=Natural2015'
                ],
                'tileSize': 256
            });
            map.addLayer(
                {
                    'id': 'wms-test-layer',
                    'type': 'raster',
                    'source': 'wms-test-source',
                    'paint': {}
                },
                'aeroway-line'
            );
            map.setCenter([-74.5447, 40.6892]);
            map.setZoom(8);
        }


        function AddWebLayerGuangxi() {
            map.addLayer({
                'id': 'wms-test-layer',
                'type': 'raster',
                'source': {
                    'type': 'raster',
                    'tiles': [
                        "http://localhost:6163/igs/rest/mrms/docs/广西省行政区域?bbox={bbox}&w={w}&h={h}&f={f}&layers={layers}&filters={filters}&style={style}&guid={guid}&proj={proj}"
                    ],
                    'tileSize': 256
                },
                'paint': {}
            });
            map.setCenter([108.438, 34.431]);
            map.setZoom(7);
        }

        //绘图
        /*******************************************************************************************************************/
        var draw = new MapboxDraw({
            displayControlsDefault: false,
            controls: {
                polygon: true,
                line_string: true,
                point: true,
                trash: true
            }
        });
        map.addControl(draw);

        map.on('draw.create', updateArea);
        map.on('draw.delete', updateArea);
        map.on('draw.update', updateArea);

        function updateArea(e) {
            var data = draw.getAll();
            var answer = document.getElementById('calculated-area');
            if (data.features.length > 0) {
                var area = turf.area(data);
                // restrict to area to 2 decimal points
                var rounded_area = Math.round(area * 100) / 100;
                answer.innerHTML = '<p><strong>' + rounded_area + '</strong></p><p>square meters</p>';
            } else {
                answer.innerHTML = '';
                if (e.type !== 'draw.delete') alert("Use the draw tools to draw a polygon!");
            }
        }






        //图层透明度控制
        /*******************************************************************************************************************/
        var slider = document.getElementById('slider');
        var sliderValue = document.getElementById('slider-value');
        document.getElementById("OpacityController").style.display = "none";
        function OpacityController() {
            if (document.getElementById("OpacityController").style.display == "none") {
                document.getElementById("OpacityController").style.display = "block";
            } else if (document.getElementById("OpacityController").style.display == "block") {
                document.getElementById("OpacityController").style.display = "none";
            }
            map.addSource('chicago', {
                'type': 'raster',
                'url': 'mapbox://mapbox.u8yyzaor'
            });
            map.addLayer({
                'id': 'chicago',
                'source': 'chicago',
                'type': 'raster'
            });
            slider.addEventListener('input', function (e) {
                //调整图层的不透明度。这里的层是任意的，这个可以
                //在你的样式或自定义层中找到另一个层名
                //使用' addSource '动态添加。
                map.setPaintProperty(
                    'chicago',
                    'raster-opacity',
                    parseInt(e.target.value, 10) / 100
                );

                // Value indicator
                sliderValue.textContent = e.target.value + '%';
            });
            map.setCenter([-87.6321, 41.8362]);
            map.setZoom(9.5);
        }
    </script>
</body>

</html>